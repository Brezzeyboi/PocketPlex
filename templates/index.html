
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Media Hub</title>
    <script src="/static/taillwind.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f0f0f; }
        .header-scrolled { background-color: rgba(15, 15, 15, 0.85); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-[#0f0f0f] text-gray-100">

    <header class="fixed top-0 left-0 right-0 z-40 transition-all duration-300" id="header">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <a href="/" class="text-2xl font-bold text-white tracking-wide">My Library</a>
            </div>
        </div>
    </header>

    <main class="pt-24">
        <!-- In-Page Status Section -->
        <section id="status-section" class="container mx-auto px-4 sm:px-6 lg:px-8 mb-8">
            <!-- Status banner will be injected here by JavaScript -->
        </section>

        <!-- Movie Grid Section -->
        <section id="movie-grid-container" class="py-2"></section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const header = document.getElementById('header');
            const statusSection = document.getElementById('status-section');
            const movieGridContainer = document.getElementById('movie-grid-container');
            let wasProcessing = false;

            const svgIcons = {
                monitoring: `<svg class="w-6 h-6 text-yellow-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
                downloading: `<svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>`,
                processing: `<svg class="w-6 h-6 text-blue-400 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`
            };

            async function loadMovies() {
                try {
                    const response = await fetch('/api/movies');
                    const movies = await response.json();
                    
                    movieGridContainer.innerHTML = '';
                    if (movies.length === 0) {
                        movieGridContainer.innerHTML = '<p class="text-center text-gray-500 container mx-auto px-4">No movies found. Upload a video to get started!</p>';
                        return;
                    }

                    const gridWrapper = document.createElement('div');
                    gridWrapper.className = 'container mx-auto px-4 sm:px-6 lg:px-8';
                    gridWrapper.innerHTML = `<h2 class="text-2xl font-bold text-white mb-4">Recently Added</h2>`;
                    
                    // --- THIS IS THE NEW WRAPPING GRID LAYOUT ---
                    const movieGrid = document.createElement('div');
                    movieGrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6';
                    
                    movies.forEach(movie => {
                        const movieCard = document.createElement('a');
                        movieCard.href = `/video/${movie.id}`;
                        movieCard.className = 'group cursor-pointer';
                        movieCard.innerHTML = `
                            <div class="relative aspect-video rounded-lg overflow-hidden shadow-lg transition-all duration-300 transform group-hover:scale-105 group-hover:shadow-blue-500/20">
                                <img src="${movie.backdrop}" alt="${movie.title}" class="w-full h-full object-cover">
                            </div>
                            <h3 class="mt-2 text-md font-semibold text-gray-200">${movie.title}</h3>`;
                        movieGrid.appendChild(movieCard);
                    });
                    
                    gridWrapper.appendChild(movieGrid);
                    movieGridContainer.appendChild(gridWrapper);
                } catch (error) {
                    console.error('Failed to fetch movies:', error);
                }
            }

            async function checkStatus() {
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    let statusHTML = '';

                    if (data.status === 'monitoring' || data.status === 'downloading' || data.status === 'processing') {
                        wasProcessing = true;
                        let icon, text, progress;
                        
                        switch (data.status) {
                            case 'monitoring':
                                icon = svgIcons.monitoring;
                                text = `<strong>Monitoring:</strong> Waiting for '${data.filename}' to finish uploading...`;
                                progress = null;
                                break;
                            case 'downloading':
                                icon = svgIcons.downloading;
                                text = `<strong>Downloading:</strong> ${data.filename} (${data.progress}%)`;
                                progress = data.progress;
                                break;
                            case 'processing':
                                icon = svgIcons.processing;
                                text = `<strong>Encoding:</strong> ${data.filename} (${data.progress}%)`;
                                progress = data.progress;
                                break;
                        }

                        const progressHTML = progress !== null
                            ? `<div class="w-full bg-gray-600 rounded-full h-1.5 mt-1">
                                   <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                               </div>`
                            : '';

                        statusHTML = `
                            <div class="bg-[#212121] text-white shadow-lg p-3 rounded-lg border border-gray-700">
                                <div class="flex items-center space-x-3">
                                    <div>${icon}</div>
                                    <div class="flex-grow">
                                        <div class="text-sm font-medium">${text}</div>
                                        ${progressHTML}
                                    </div>
                                </div>
                            </div>`;
                    } else { // status is 'idle'
                        if (wasProcessing) {
                            loadMovies();
                        }
                        wasProcessing = false;
                        statusHTML = ''; // Clear the section when idle
                    }
                    statusSection.innerHTML = statusHTML;
                } catch (error) {
                    console.error('Could not fetch status:', error);
                }
            }
            
            window.addEventListener('scroll', () => {
                header.classList.toggle('header-scrolled', window.scrollY > 20);
            });

            loadMovies();
            setInterval(checkStatus, 2000);
        });
    </script>
</body>
</html>
